<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AURA OS | SINGULARITY 8.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root { --bg: #020204; --accent: #6366f1; --sidebar-w: 280px; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: #e2e8f0; overflow: hidden; height: 100vh; }
        .mono { font-family: 'JetBrains Mono', monospace; }

        /* --- LAYOUT FIXES --- */
        #sidebar { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); width: var(--sidebar-w); z-index: 50; }
        #sidebar.collapsed { width: 0px; opacity: 0; pointer-events: none; transform: translateX(-20px); }
        
        .terminal-hidden #log-terminal { height: 0; padding: 0; border: none; opacity: 0; }
        
        /* Strict View Toggle */
        .page-view { display: none; height: 100%; width: 100%; opacity: 0; }
        .page-view.active { display: flex; flex-direction: column; opacity: 1; }

        /* --- EXPANDABLE KANBAN --- */
        .workspace-grid { display: flex; gap: 1.5rem; height: 100%; width: 100%; transition: 0.5s ease; }
        .kanban-col { flex: 1; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; background: rgba(255,255,255,0.01); border: 1px solid rgba(255,255,255,0.03); border-radius: 24px; min-width: 0; }
        .kanban-col.expanded { flex: 12; background: rgba(255,255,255,0.03); border-color: var(--accent); }
        .kanban-col.hidden-col { flex: 0; width: 0; opacity: 0; margin: 0; padding: 0; pointer-events: none; border: none; }

        .task-card { background: #0d0d14; border: 1px solid rgba(255,255,255,0.05); padding: 1.25rem; border-radius: 16px; margin-bottom: 1rem; transition: 0.3s; }
        .task-card.hidden-search { display: none; }

        #log-terminal { height: 140px; background: #050508; border-top: 1px solid rgba(255,255,255,0.05); padding: 12px 24px; transition: all 0.3s; z-index: 60; }
        
        .glass-header { background: rgba(2, 2, 4, 0.8); backdrop-filter: blur(20px); z-index: 40; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .scroll-v { overflow-y: auto; scrollbar-gutter: stable; height: 100%; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <div class="flex flex-1 min-h-0 overflow-hidden">
        <aside id="sidebar" class="bg-[#050508] border-r border-white/5 flex flex-col shrink-0">
            <div class="p-8">
                <div class="flex items-center gap-4 mb-10">
                    <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center font-black text-white">AÎ©</div>
                    <span class="font-black text-xl tracking-tighter">AURA_S8</span>
                </div>

                <div class="space-y-1">
                    <p class="text-[10px] mono text-slate-500 uppercase tracking-widest mb-4">Environment</p>
                    <div id="project-list" class="space-y-2"></div>
                    <button onclick="openPModal()" class="w-full mt-4 py-3 border border-dashed border-white/10 rounded-xl text-[10px] mono text-slate-500 hover:text-white transition">+ NEW_SPACE</button>
                    <button onclick="downloadProject()" class="w-full mt-2 py-3 bg-white/5 rounded-xl text-[10px] mono text-indigo-400 hover:bg-indigo-500 hover:text-white transition">â†“ DOWNLOAD_JSON</button>
                </div>
            </div>

            <nav class="mt-8 border-t border-white/5">
                <div onclick="navigateTo('dashboard')" id="nav-dashboard" class="p-6 flex items-center gap-4 cursor-pointer hover:bg-white/5 transition">
                    <span class="text-xl">âŠž</span><span class="mono text-xs font-bold uppercase">Dashboard</span>
                </div>
                <div onclick="navigateTo('kanban')" id="nav-kanban" class="p-6 flex items-center gap-4 cursor-pointer hover:bg-white/5 transition border-l-4 border-indigo-500 bg-indigo-500/5">
                    <span class="text-xl">ðŸ“‹</span><span class="mono text-xs font-bold uppercase">Workspace</span>
                </div>
            </nav>

            <div class="mt-auto p-8 border-t border-white/5">
                <p class="text-[9px] mono text-slate-500 uppercase mb-2">Focus_Time</p>
                <div id="session-timer" class="text-2xl font-black mono text-white">00:00:00</div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 relative bg-[#020204]">
            <header class="glass-header px-10 py-6 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-6">
                    <button onclick="toggleSidebar()" class="w-10 h-10 rounded-xl border border-white/5 flex items-center justify-center text-slate-400 hover:text-white transition">â˜°</button>
                    <div>
                        <h1 id="page-title" class="text-xl font-black text-white tracking-tight">WORKSPACE</h1>
                        <p id="proj-display" class="text-[8px] mono text-indigo-400 uppercase tracking-[0.3em]">PROJ: DEFAULT</p>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <div class="relative">
                        <input type="text" id="search-bar" oninput="executeSearch()" placeholder="SEARCH_NODES..." class="bg-white/5 border border-white/10 rounded-xl px-4 py-2 text-[10px] mono text-white outline-none focus:border-indigo-500 w-48 transition-all">
                    </div>
                    <button onclick="toggleTerminal()" class="px-4 py-2 text-[10px] mono text-slate-500 hover:text-white">TERM</button>
                    <button onclick="openFModal()" class="bg-indigo-600 text-white px-6 py-2.5 rounded-xl font-bold text-[10px] uppercase tracking-widest hover:bg-indigo-500 transition">+ NEW_FILE</button>
                </div>
            </header>

            <div class="flex-1 p-10 overflow-hidden relative">
                <section id="page-kanban" class="page-view active">
                    <div class="workspace-grid" id="kanban-grid">
                        <div class="kanban-col" id="col-todo">
                            <div class="p-5 border-b border-white/5 flex justify-between items-center">
                                <span class="text-[9px] mono font-bold text-slate-500">SOURCE</span>
                                <button onclick="expandCol('todo')" class="text-slate-600 hover:text-white text-xs">â›¶</button>
                            </div>
                            <div id="todo" class="scroll-v p-5 drop-zone"></div>
                        </div>
                        <div class="kanban-col" id="col-progress">
                            <div class="p-5 border-b border-white/5 flex justify-between items-center">
                                <span class="text-[9px] mono font-bold text-indigo-400">BUILD</span>
                                <button onclick="expandCol('progress')" class="text-slate-600 hover:text-white text-xs">â›¶</button>
                            </div>
                            <div id="progress" class="scroll-v p-5 drop-zone"></div>
                        </div>
                        <div class="kanban-col" id="col-done">
                            <div class="p-5 border-b border-white/5 flex justify-between items-center">
                                <span class="text-[9px] mono font-bold text-emerald-400">DEPLOYED</span>
                                <button onclick="expandCol('done')" class="text-slate-600 hover:text-white text-xs">â›¶</button>
                            </div>
                            <div id="done" class="scroll-v p-5 drop-zone"></div>
                        </div>
                    </div>
                </section>

                <section id="page-dashboard" class="page-view">
                    <div class="grid grid-cols-12 gap-8 h-full">
                        <div class="col-span-12 lg:col-span-5 bg-[#08080c] border border-white/5 rounded-[32px] p-10 flex flex-col items-center justify-center">
                            <div class="w-full max-w-[240px]"><canvas id="gaugeChart"></canvas></div>
                            <h2 class="text-6xl font-black text-white mt-8" id="velocity-val">0%</h2>
                            <p class="text-[10px] mono text-slate-500 uppercase mt-2">Environment_Efficiency</p>
                        </div>
                        <div class="col-span-12 lg:col-span-7 bg-[#08080c] border border-white/5 rounded-[32px] p-10 flex flex-col overflow-hidden">
                            <p class="text-[10px] mono text-slate-500 mb-8 uppercase">Metric_Breakdown</p>
                            <div id="stats-bars" class="space-y-8 scroll-v pr-4"></div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <footer id="log-terminal" class="mono flex flex-col shrink-0">
        <div class="flex justify-between items-center mb-2 border-b border-white/5 pb-2">
            <span class="text-[9px] font-bold text-indigo-500 uppercase tracking-widest">Aura_v8.1_Runtime</span>
            <button onclick="clearLogs()" class="text-[9px] text-slate-700 hover:text-white">CLEAR</button>
        </div>
        <div id="log-stream" class="scroll-v flex flex-col-reverse text-[10px] opacity-60"></div>
    </footer>

    <div id="f-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/95 backdrop-blur-3xl p-6">
        <div class="bg-[#0a0a0f] border border-white/10 w-full max-w-4xl h-[70vh] flex flex-col rounded-[32px] overflow-hidden">
            <div class="p-6 border-b border-white/5 flex justify-between items-center">
                <span class="mono text-[10px] text-slate-500">FS // COMMIT</span>
                <button onclick="closeFModal()" class="text-slate-500 hover:text-white text-xs">CLOSE</button>
            </div>
            <div class="flex-1 p-10 flex flex-col gap-4">
                <input type="text" id="f-title" placeholder="Node_Name.sh" class="bg-transparent text-3xl font-black text-white outline-none">
                <textarea id="f-content" placeholder="System content meta-stream..." class="flex-1 bg-white/[0.02] border border-white/5 p-6 rounded-2xl text-indigo-200 mono text-sm outline-none resize-none focus:border-indigo-500/50"></textarea>
            </div>
            <div class="p-8 border-t border-white/5 flex justify-end">
                <button onclick="commitFile()" class="bg-indigo-600 px-10 py-3 rounded-xl text-white font-bold text-[10px] uppercase">Commit_to_Environment</button>
            </div>
        </div>
    </div>

    <div id="p-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center bg-black/90 backdrop-blur-xl">
        <div class="bg-[#0d0d14] border border-white/10 w-full max-w-sm p-8 rounded-2xl">
            <p class="mono text-[10px] text-indigo-400 mb-4 uppercase">New_Space</p>
            <input type="text" id="p-name" placeholder="Project_Identifier" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl text-white outline-none mb-6">
            <button onclick="createP()" class="w-full bg-white text-black py-4 rounded-xl font-bold text-xs uppercase">Initialize</button>
        </div>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('aura_s81')) || {
            activeProject: 'Default',
            projects: { 'Default': [] },
            totalSecs: 0
        };

        const sysLog = (msg, type='info') => {
            const colors = { success: 'text-emerald-400', crit: 'text-rose-500', info: 'text-slate-500' };
            document.getElementById('log-stream').insertAdjacentHTML('afterbegin', `<div class="py-1"><span class="text-slate-800 mr-2">[${new Date().toLocaleTimeString()}]</span><span class="${colors[type]}">> ${msg}</span></div>`);
        };

        const save = () => {
            localStorage.setItem('aura_s81', JSON.stringify(db));
            document.getElementById('proj-display').innerText = `PROJ: ${db.activeProject}`;
            renderProjects();
            renderCurrentView();
        };

        // --- TIMER ---
        setInterval(() => {
            db.totalSecs++;
            const h = Math.floor(db.totalSecs / 3600).toString().padStart(2, '0');
            const m = Math.floor((db.totalSecs % 3600) / 60).toString().padStart(2, '0');
            const s = (db.totalSecs % 60).toString().padStart(2, '0');
            document.getElementById('session-timer').innerText = `${h}:${m}:${s}`;
        }, 1000);

        // --- SEARCH ENGINE ---
        function executeSearch() {
            const term = document.getElementById('search-bar').value.toLowerCase();
            const cards = document.querySelectorAll('.task-card');
            cards.forEach(card => {
                const text = card.innerText.toLowerCase();
                card.classList.toggle('hidden-search', !text.includes(term));
            });
        }

        // --- DOWNLOAD PROJECT ---
        function downloadProject() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `aura_backup_${db.activeProject}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            sysLog('Project backup generated', 'success');
        }

        // --- EXPANSION LOGIC ---
        let expandedColId = null;
        function expandCol(id) {
            const cols = ['todo', 'progress', 'done'];
            if (expandedColId === id) {
                cols.forEach(c => document.getElementById(`col-${c}`).classList.remove('expanded', 'hidden-col'));
                expandedColId = null;
            } else {
                cols.forEach(c => {
                    const el = document.getElementById(`col-${c}`);
                    el.classList.toggle('expanded', c === id);
                    el.classList.toggle('hidden-col', c !== id);
                });
                expandedColId = id;
            }
        }

        // --- CORE KERNEL ---
        function commitFile() {
            const title = document.getElementById('f-title').value;
            const content = document.getElementById('f-content').value;
            if(!title) return;
            db.projects[db.activeProject].push({ id: Date.now(), serial: `NODE-${Math.floor(Math.random()*9000+1000)}`, title, info: content, status: 'todo' });
            save(); closeFModal(); sysLog(`Node ${title} commited`, 'success');
        }

        function renderBoard() {
            const cols = { todo: '', progress: '', done: '' };
            db.projects[db.activeProject].forEach(t => {
                cols[t.status] += `<div class="task-card" data-id="${t.id}">
                    <div class="flex justify-between items-center mb-3"><span class="text-[8px] mono text-indigo-500 font-bold tracking-widest">${t.serial}</span><button onclick="delF(${t.id})" class="text-slate-800 hover:text-rose-500 transition">Ã—</button></div>
                    <h4 class="text-xs font-bold text-white mb-2">${t.title}</h4>
                    <p class="text-[10px] text-slate-500 mono line-clamp-2">${t.info}</p>
                </div>`;
            });
            ['todo', 'progress', 'done'].forEach(id => {
                const el = document.getElementById(id); el.innerHTML = cols[id];
                new Sortable(el, { group: 'singular', animation: 200, onEnd: (e) => {
                    const f = db.projects[db.activeProject].find(t => t.id == e.item.dataset.id);
                    f.status = e.to.id;
                    save();
                }});
            });
        }

        function renderDashboard() {
            const files = db.projects[db.activeProject];
            const total = files.length || 1;
            const done = files.filter(t => t.status === 'done').length;
            const p = Math.round((done / total) * 100);
            document.getElementById('velocity-val').innerText = p + "%";
            const ctx = document.getElementById('gaugeChart').getContext('2d');
            if(window.g) window.g.destroy();
            window.g = new Chart(ctx, { type: 'doughnut', data: { datasets: [{ data: [p, 100-p], backgroundColor: ['#6366f1', 'rgba(255,255,255,0.02)'], borderWidth: 0 }] }, options: { cutout: '85%', plugins: { legend: false }}});
            document.getElementById('stats-bars').innerHTML = ['todo', 'progress', 'done'].map(s => {
                const count = files.filter(t => t.status === s).length;
                const pct = Math.round((count / total) * 100);
                return `<div class="space-y-2"><div class="flex justify-between mono text-[9px] uppercase text-slate-500"><span>${s}</span><span>${count} NODES</span></div><div class="h-1 bg-white/5 rounded-full overflow-hidden"><div class="h-full bg-indigo-500" style="width:${pct}%"></div></div></div>`;
            }).join('');
        }

        // --- NAVIGATION ---
        function navigateTo(id) {
            document.querySelectorAll('.page-view').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${id}`).classList.add('active');
            
            // Highlight nav
            document.querySelectorAll('[id^="nav-"]').forEach(n => n.classList.remove('bg-indigo-500/5', 'border-l-4', 'border-indigo-500'));
            const activeNav = document.getElementById(`nav-${id}`);
            activeNav.classList.add('bg-indigo-500/5', 'border-l-4', 'border-indigo-500');
            
            document.getElementById('page-title').innerText = id.toUpperCase();
            renderCurrentView();
        }

        function renderCurrentView() {
            const activeId = document.querySelector('.page-view.active').id;
            if(activeId === 'page-dashboard') renderDashboard();
            if(activeId === 'page-kanban') renderBoard();
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }
        function toggleTerminal() { document.body.classList.toggle('terminal-hidden'); }
        function openFModal() { document.getElementById('f-modal').classList.remove('hidden'); }
        function closeFModal() { document.getElementById('f-modal').classList.add('hidden'); }
        function openPModal() { document.getElementById('p-modal').classList.remove('hidden'); }
        function createP() {
            const n = document.getElementById('p-name').value;
            if(n) { db.projects[n] = []; db.activeProject = n; save(); document.getElementById('p-modal').classList.add('hidden'); }
        }
        function renderProjects() {
            document.getElementById('project-list').innerHTML = Object.keys(db.projects).map(p => `
                <div onclick="db.activeProject='${p}';save()" class="p-3 rounded-xl text-[10px] mono flex justify-between group cursor-pointer ${db.activeProject === p ? 'bg-indigo-500/10 text-white' : 'text-slate-500 hover:bg-white/5'}">
                    <span>${p}</span>
                    <button onclick="delP('${p}', event)" class="opacity-0 group-hover:opacity-100 text-rose-500">Ã—</button>
                </div>`).join('');
        }
        function delP(n, e) { e.stopPropagation(); if(Object.keys(db.projects).length > 1) { delete db.projects[n]; db.activeProject = Object.keys(db.projects)[0]; save(); } }
        function delF(id) { db.projects[db.activeProject] = db.projects[db.activeProject].filter(f => f.id !== id); save(); }
        function clearLogs() { document.getElementById('log-stream').innerHTML = ''; }

        window.onload = () => { save(); sysLog('System Singularity 8.1 Online', 'success'); navigateTo('kanban'); };
    </script>
</body>
</html>